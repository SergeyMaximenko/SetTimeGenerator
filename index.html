<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>Заправка генератора</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  body { margin:0; padding:16px; font-family:-apple-system, Segoe UI, Roboto, Arial; }
  .box { max-width:420px; margin:0 auto; }

  .label {
    text-align:center;
    font-size:24px;
    font-weight:600;
    margin: 10px 0 18px;
  }

  .field-label{
    font-size:18px;
    font-weight:600;
    margin-top:14px;
    margin-bottom:6px;
  }

  /* ===== INPUT WRAPPER (FIX iOS WIDTH) ===== */
  .input-wrap{
    width:100%;
    max-width:100%;
    box-sizing:border-box;
    overflow:hidden;           /* ключове для iOS */
  }

  .input-wrap input{
    width:100%;
    height:56px;
    font-size:28px;
    border-radius:14px;
    border:2px solid #2aabee;
    padding:0 12px;
    box-sizing:border-box;
    background:#fff;

    -webkit-appearance:none;
    appearance:none;
  }

  /* Прибираємо iOS native іконки (календар / час) */
  input[type="date"]::-webkit-calendar-picker-indicator,
  input[type="time"]::-webkit-calendar-picker-indicator{
    opacity:0;
    display:none;
    -webkit-appearance:none;
  }

  /* ===== BUTTON ===== */
  button{
    width:100%;
    max-width:100%;
    height:56px;
    margin-top:18px;
    font-size:28px;
    border:0;
    border-radius:14px;
    background:#2aabee;
    color:#fff;
    font-weight:700;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    cursor:pointer;
    box-sizing:border-box;
  }

  button:disabled{
    opacity:.6;
    cursor:not-allowed;
  }

  .hint{
    margin-top:12px;
    font-size:14px;
    opacity:.85;
    text-align:center;
    min-height:20px;
  }

  /* ===== SPINNER ===== */
  .spinner{
    width:22px;
    height:22px;
    border-radius:50%;
    border:3px solid rgba(255,255,255,.45);
    border-top-color:#fff;
    animation:spin 0.8s linear infinite;
    display:none;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Коли йде збереження */
  .saving .spinner{ display:inline-block; }
</style>

</head>

<body>
  <div class="box">
    <div class="label">Вкажіть дату та час заправки генератора</div>

    <div class="field-label">Дата</div>
    <input type="date" id="date" />

    <div class="field-label">Час</div>
    <input type="time" id="time" step="60" />

    <button id="btnSave" onclick="send()">
      <span class="spinner" aria-hidden="true"></span>
      <span id="btnText">Зберегти</span>
    </button>

    <div class="hint" id="status"></div>
  </div>

  <script>
    // ✅ ВСТАВ СЮДИ СВІЙ URL Apps Script (без зайвих параметрів типу ?вы=2)
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxrC-JQWWUTJgXmIjk-_MUabT6Cub_f9oVKNouUvRx2u6GYSkelUc0Z69MJcwCa4eBr/exec";

    const elDate = document.getElementById("date");
    const elTime = document.getElementById("time");
    const btn = document.getElementById("btnSave");
    const btnText = document.getElementById("btnText");
    const statusEl = document.getElementById("status");

    function setStatus(text) { statusEl.textContent = text || ""; }

    function setUiState(state) {
      // state: "idle" | "saving" | "saved" | "error"
      if (state === "saving") {
        elDate.disabled = true;
        elTime.disabled = true;
        btn.disabled = true;              // щоб не натискали повторно
        btn.classList.add("saving");
        btnText.textContent = "Збереження…";
        setStatus("Йде збереження…");
        return;
      }

      if (state === "saved") {
        elDate.disabled = true;
        elTime.disabled = true;
        btn.disabled = true;              // після успіху лишаємо disabled
        btn.classList.remove("saving");
        btnText.textContent = "Збережено";
        setStatus("✅ Дякуємо за заправку");
        return;
      }

      if (state === "error") {
        elDate.disabled = false;
        elTime.disabled = false;
        btn.disabled = false;             // при помилці даємо спробувати ще раз
        btn.classList.remove("saving");
        btnText.textContent = "Зберегти";
        return;
      }

      // idle
      elDate.disabled = false;
      elTime.disabled = false;
      btn.disabled = false;
      btn.classList.remove("saving");
      btnText.textContent = "Зберегти";
      setStatus("");
    }

    // Поточна дата/час по Києву
    function setNowKyivDefaults() {
      const tz = "Europe/Kyiv";
      const d = new Date();

      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: tz,
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      }).formatToParts(d);

      const map = {};
      for (const p of parts) if (p.type !== "literal") map[p.type] = p.value;

      elDate.value = `${map.year}-${map.month}-${map.day}`;
      elTime.value = `${map.hour}:${map.minute}`;
    }

    setNowKyivDefaults();

    async function send() {
      const tg = window.Telegram?.WebApp || null;

      const date = elDate.value;
      const time = elTime.value;

      if (!date) { alert("Вкажіть дату"); return; }
      if (!time) { alert("Вкажіть час"); return; }

      try {
        setUiState("saving");

        const params = new URLSearchParams({
          action: "save",
          user_id: tg?.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : "",
          username: tg?.initDataUnsafe?.user?.username || "",
          platform: tg?.platform || "",
          datetime: `${date} ${time}`
        });

        const url = GAS_URL + "?" + params.toString();

        const res = await fetch(url, { method: "GET" });

        // якщо GAS повернув не JSON (інколи буває при помилці деплою)
        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch { json = { ok:false, error:text }; }

        if (!json.ok) {
          setStatus("❌ Помилка: " + (json.error || "unknown"));
          setUiState("error");
          if (tg) tg.HapticFeedback?.notificationOccurred?.("error");
          return;
        }

        setUiState("saved");
        if (tg) tg.HapticFeedback?.notificationOccurred?.("success");

      } catch (err) {
        setStatus("❌ Помилка: " + err.message);
        setUiState("error");
        const tg = window.Telegram?.WebApp || null;
        if (tg) tg.HapticFeedback?.notificationOccurred?.("error");
      }
    }
  </script>
</body>
</html>
