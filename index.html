<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–ó–∞–ø—Ä–∞–≤–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
body {
  margin: 0;
  padding: 16px;
  font-family: -apple-system, Segoe UI, Roboto, Arial;
}

.box {
  max-width: 420px;
  margin: 0 auto;
}

.label {
  text-align: center;
  font-size: 24px;
  font-weight: 600;
  margin: 10px 0 18px;
}

.field-label {
  font-size: 18px;
  font-weight: 600;
  margin-top: 14px;
  margin-bottom: 6px;
}
    
.__input-error {
  border-color: #e53935 !important;   /* —á–µ—Ä–≤–æ–Ω–∞ —Ä–∞–º–∫–∞ */
  box-shadow: 0 0 0 2px rgba(229,57,53,0.15);
}
    
input[type="number"],
input[type="date"],
input[type="time"] {
  height: 56px;
  font-size: 28px;
  border-radius: 14px;
  border: 2px solid #2aabee;
  padding: 0 12px;
  box-sizing: border-box;
  background: #fff;
}

button {
  width: 100%;
  height: 56px;
  margin-top: 18px;
  font-size: 28px;
  font-weight: 700;
  border: 0;
  border-radius: 14px;
  background: #2aabee;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  cursor: pointer;
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.hint {
  margin-top: 12px;
  font-size: 14px;
  opacity: 0.85;
  text-align: center;
  min-height: 20px;
}

/* –ü—Ä–æ—Å—Ç–∏–π —Å–ø—ñ–Ω–Ω–µ—Ä */
.spinner {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 3px solid rgba(255, 255, 255, 0.45);
  border-top-color: #fff;
  animation: spin 0.8s linear infinite;
  display: none;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* –ö–æ–ª–∏ –π–¥–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è */
.saving .spinner { display: inline-block; }

/* –ö–æ–ª–∏ –π–¥–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É */
.checking .spinner { display: inline-block; }
</style>

</head>

<body>
  <div class="box">
    <div class="label">–ü–æ–∫–∞–∑–Ω–∏–∫–∏ –∑–∞–ø—Ä–∞–≤–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞</div>

    <div class="field-label">–î–∞—Ç–∞ –∑–∞–ø—Ä–∞–≤–∫–∏</div>
    <input type="date" style="width: 90%;" id="date" />

    <div class="field-label">–ß–∞—Å –∑–∞–ø—Ä–∞–≤–∫–∏</div>
    <input type="time" style="width:90%;" id="time" step="60" />
     
    <div class="field-label">–°–∫—ñ–ª—å–∫–∏ –ª—ñ—Ç—Ä—ñ–≤ –∑–∞–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
    <input type="number" id="liters" style="width:4em;" inputmode="numeric" min="0" max="200" step="1"  />
   
    <button id="btnSave" onclick="send()">
      <span class="spinner" aria-hidden="true"></span>
      <span id="btnText">–ó–±–µ—Ä–µ–≥—Ç–∏</span>
    </button>

    <div class="hint" id="status"></div>
  </div>

  <script>
    // ‚úÖ URL Apps Script
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxrC-JQWWUTJgXmIjk-_MUabT6Cub_f9oVKNouUvRx2u6GYSkelUc0Z69MJcwCa4eBr/exec";

    const elDate = document.getElementById("date");
    const elTime = document.getElementById("time");
    const elLiters = document.getElementById("liters");
    
    const btn = document.getElementById("btnSave");
    const btnText = document.getElementById("btnText");
    const statusEl = document.getElementById("status");

    //function setStatus(text) { statusEl.innerHTML  = text || ""; }

    elLiters.addEventListener("input", () => {
      let v = elLiters.value.replace(/\D/g, ""); // —Ç—ñ–ª—å–∫–∏ —Ü–∏—Ñ—Ä–∏
      if (v.length > 3) v = v.slice(0, 3);
      elLiters.value = v;
    });
    
    function setStatus(icon, text) {
      if (!icon && !text) {
        statusEl.innerHTML = "";
        return;
      }
    
      
      statusEl.innerHTML = `
        <div style="
          display:flex;
          align-items:center;        /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–µ –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è —ñ–∫–æ–Ω–∫–∏ + —Ç–µ–∫—Å—Ç—É */
          justify-content:center;    /* —Ü–µ–Ω—Ç—Ä –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—ñ */
          min-height:48px;
          gap:10px;
          text-align:left;
        ">
          ${icon ? `
            <div style="
              font-size:22px;
              line-height:1;
              flex-shrink:0;
            ">${icon}</div>
          ` : ""}
          ${text ? `
            <div style="
              font-size:14px;
              opacity:0.9;
              line-height:1.25;
            ">${text}</div>
          ` : ""}
        </div>
      `;
    }

    
    function setUiState(state) {
      // state: "checking" | "blocked" | "idle" | "saving" | "saved" | "error"
      const tg = window.Telegram?.WebApp || null;
      var userName = tg?.initDataUnsafe?.user?.first_name ? String(tg.initDataUnsafe.user.first_name) : "";
      
      if (state === "checking") {
        elDate.disabled = false;
        elLiters.disabled = false;
        elTime.disabled = false;
        btn.disabled = true;
        btn.classList.add("checking");
        btn.classList.remove("saving");
        btnText.textContent = "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞‚Ä¶";
        setStatus("‚è≥","–ü–µ—Ä–µ–≤—ñ—Ä—è—é –¥–æ—Å—Ç—É–ø‚Ä¶");
        return;
      }

      if (state === "blocked") {
        elDate.disabled = false;
        elLiters.disabled = false;
        elTime.disabled = false;
        btn.disabled = true;
        btn.classList.remove("checking");
        btn.classList.remove("saving");
        btnText.textContent = "–ó–±–µ—Ä–µ–≥—Ç–∏";
        // status –≤–∂–µ –≤–∏—Å—Ç–∞–≤–ª—è—î—Ç—å—Å—è –∑–∑–æ–≤–Ω—ñ (–ø–æ–º–∏–ª–∫–∞)
        return;
      }

      if (state === "saving") {
        elDate.disabled = true;
        elLiters.disabled = true;
        elTime.disabled = true;
        btn.disabled = true;
        btn.classList.remove("checking");
        btn.classList.add("saving");
        btnText.textContent = "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶";
        setStatus("‚è≥","–ô–¥–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶");
        return;
      }

      if (state === "saved") {
        elDate.disabled = true;
        elLiters.disabled = true;
        elTime.disabled = true;
        btn.disabled = true;
        btn.classList.remove("checking");
        btn.classList.remove("saving");
        btnText.textContent = "‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ";
        setStatus("ü§ù",userName+", –¥—è–∫—É—î–º–æ –∑–∞ –∑–∞–ø—Ä–∞–≤–∫—É!"); //
        return;
      }

      if (state === "error") {
        elDate.disabled = false;
        elLiters.disabled = false;
        elTime.disabled = false;
        btn.disabled = false;
        btn.classList.remove("checking");
        btn.classList.remove("saving");
        btnText.textContent = "–ó–±–µ—Ä–µ–≥—Ç–∏";
        return;
      }

      // idle
      elDate.disabled = false;
      elLiters.disabled = false;
      elTime.disabled = false;
      btn.disabled = false;
      btn.classList.remove("checking");
      btn.classList.remove("saving");
      btnText.textContent = "–ó–±–µ—Ä–µ–≥—Ç–∏";
      setStatus("üîë",userName+", —É –≤–∞—Å —î –¥–æ—Å—Ç—É–ø –¥–æ –≤–Ω–µ—Å–µ–Ω–Ω—è –ø–æ–∫–∞–∑–Ω–∏–∫—ñ–≤");
    }

    // –ü–æ—Ç–æ—á–Ω–∞ –¥–∞—Ç–∞/—á–∞—Å –ø–æ –ö–∏—î–≤—É
    function setNowKyivDefaults() {
      const tz = "Europe/Kyiv";
      const d = new Date();

      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: tz,
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      }).formatToParts(d);

      const map = {};
      for (const p of parts) if (p.type !== "literal") map[p.type] = p.value;

      elDate.value = `${map.year}-${map.month}-${map.day}`;
      elTime.value = `${map.hour}:${map.minute}`;
    }

    // ‚úÖ "–ó–∞—Ä–∞–∑" —É –ö–∏—î–≤—ñ —è–∫ Date (–¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫)
function getNowKyiv() {
  const tz = "Europe/Kyiv";
  const d = new Date();

  const parts = new Intl.DateTimeFormat("en-CA", {
    timeZone: tz,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false
  }).formatToParts(d);

  const m = {};
  for (const p of parts) if (p.type !== "literal") m[p.type] = p.value;

  // –°–æ–∑–¥–∞—ë–º Date –∏–∑ "–∫–∏–µ–≤—Å–∫–∏—Ö" –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
  return new Date(
    Number(m.year),
    Number(m.month) - 1,
    Number(m.day),
    Number(m.hour),
    Number(m.minute),
    Number(m.second)
  );
}

// ‚úÖ –ü–∞—Ä—Å–∏–º –≤–≤–µ–¥—ë–Ω–Ω—ã–µ date+time –≤ Date
function parseInputDateTime(dateStr, timeStr) {
  const [y, mo, d] = (dateStr || "").split("-").map(Number);
  const [hh, mm] = (timeStr || "").split(":").map(Number);

  if (!y || !mo || !d || Number.isNaN(hh) || Number.isNaN(mm)) return null;

  return new Date(y, mo - 1, d, hh, mm, 0);
}
    
    function markError(el) {
      if (!el.value) el.classList.add("input-error");
      else el.classList.remove("input-error");
    }

    // ‚úÖ 1) –û–¥—Ä–∞–∑—É –±–ª–æ–∫—É—î–º–æ —Ñ–æ—Ä–º—É
    setUiState("checking");

    // ‚úÖ 2) –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –¥–æ—Å—Ç—É–ø—É (–±–µ–∑ top-level await)
    (async function checkAccessOnLoad() {
      try {
        const tg = window.Telegram?.WebApp || null;

        const params = new URLSearchParams({
          action: "checkAccess",
          user_id:   tg?.initDataUnsafe?.user?.id       ? String(tg.initDataUnsafe.user.id)       : "",
          user_code: tg?.initDataUnsafe?.user?.username ? String(tg.initDataUnsafe.user.username) : "",
          user_name: tg?.initDataUnsafe?.user?.first_name ? String(tg.initDataUnsafe.user.first_name) : ""
        });

        const url = GAS_URL + "?" + params.toString();

        const res = await fetch(url, { method: "GET", cache: "no-store" });

        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch { json = { ok: false, error: text }; }

        if (!json.ok) {
          setStatus("‚ùå", (json.error || "–ù–µ–º–∞ –¥–æ—Å—Ç—É–ø—É"));
          setUiState("blocked");
          return;
        }

        // ‚úÖ –î–æ—Å—Ç—É–ø —î ‚Äî —Ä–æ–∑–±–ª–æ–∫–æ–≤—É—î–º–æ —Ñ–æ—Ä–º—É
        setUiState("idle");

      } catch (e) {
        console.error(e);
        setStatus("‚ùå","–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø—É");
        setUiState("blocked");
      }
    })();

    // –î–∞–ª—ñ ‚Äî —Ç–≤–æ—è —ñ—Å–Ω—É—é—á–∞ –ª–æ–≥—ñ–∫–∞
    setNowKyivDefaults();

    [elDate, elTime, elLiters].forEach(el => {
      el.addEventListener("input", () => markError(el));
    });
    markError(elDate);
    markError(elTime);
    markError(elLiters);

    async function send() {
      const tg = window.Telegram?.WebApp || null;

      const date = elDate.value;
      const time = elTime.value;
      const liters = elLiters.value;

      if (!date) { alert("–í–∫–∞–∂—ñ—Ç—å –¥–∞—Ç—É"); return; }
      if (!time) { alert("–í–∫–∞–∂—ñ—Ç—å —á–∞—Å"); return; }
      if (elLiters.value>=200) { alert("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –æ–±'—î–º "); return; }
      
// ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏ —á–∞—Å—É (–∑–∞ –ö–∏—î–≤–æ–º)
const nowKyiv = getNowKyiv();
const inputDt = parseInputDateTime(date, time);

if (!inputDt) {
  alert("–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–æ –≤–∫–∞–∑–∞–Ω—ñ –¥–∞—Ç–∞ –∞–±–æ —á–∞—Å");
  return;
}

// 1) –ù–µ –º–æ–∂–µ –±—É—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —á–∞—Å—É (–ö–∏—ó–≤)
if (inputDt.getTime() > nowKyiv.getTime()) {
  alert("‚ùó –í–∫–∞–∑–∞–Ω–∏–π —á–∞—Å –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –±—ñ–ª—å—à–∏–º –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–π ");
  return;
}

      
      if (!liters) {
        if (!confirm(`–ó–±–µ—Ä–µ–≥—Ç–∏ –¥–∞–Ω—ñ –±–µ–∑ –≤–∫–∞–∑–∞–Ω–æ–≥–æ –æ–±'—î–º—É ‚õΩ –∑–∞–ø—Ä–∞–≤–∫–∏?`)) return;
      } else {
        if (!confirm(`–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î—Ç–µ –∑–∞–ø—Ä–∞–≤–∫—É \n‚õΩ ${elLiters.value} –ª—ñ—Ç—Ä—ñ–≤?`)) return;
      }

      try {
        setUiState("saving");

        const params = new URLSearchParams({
          action: "save",
          date_zp: `${date} ${time}`,
          liters: String(liters),
          user_id:   tg?.initDataUnsafe?.user?.id         ? String(tg.initDataUnsafe.user.id)         : "",
          user_code: tg?.initDataUnsafe?.user?.username   ? String(tg.initDataUnsafe.user.username)   : "",
          user_name: tg?.initDataUnsafe?.user?.first_name ? String(tg.initDataUnsafe.user.first_name) : "",
          platform:  tg?.platform || "",
          dop_param: tg?.initDataUnsafe?.start_param      ? String(tg.initDataUnsafe.start_param)     : ""
        });

        const url = GAS_URL + "?" + params.toString();

        const res = await fetch(url, { method: "GET" });

        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch { json = { ok:false, error:text }; }

        if (!json.ok) {
          setStatus("‚ùå","–ü–æ–º–∏–ª–∫–∞: " + (json.error || "unknown"));
          setUiState("error");
          if (tg) tg.HapticFeedback?.notificationOccurred?.("error");
          return;
        }

        setUiState("saved");
        if (tg) tg.HapticFeedback?.notificationOccurred?.("success");

      } catch (err) {
        setStatus("‚ùå","–ü–æ–º–∏–ª–∫–∞: " + err.message);
        setUiState("error");
        if (tg) tg.HapticFeedback?.notificationOccurred?.("error");
      }
    }
  </script>
</body>
</html>
