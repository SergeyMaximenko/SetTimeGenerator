<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>Заправка генератора</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
body {
  margin: 0;
  padding: 16px;
  font-family: -apple-system, Segoe UI, Roboto, Arial;
}

.box {
  max-width: 420px;
  margin: 0 auto;
}

.label {
  text-align: center;
  font-size: 24px;
  font-weight: 600;
  margin: 10px 0 18px;
}

.field-label {
  font-size: 18px;
  font-weight: 600;
  margin-top: 14px;
  margin-bottom: 6px;
}
    
.__input-error {
  border-color: #e53935 !important;   /* червона рамка */
  box-shadow: 0 0 0 2px rgba(229,57,53,0.15);
}
    
input[type="number"],
input[type="date"],
input[type="time"] {
  height: 56px;
  font-size: 28px;
  border-radius: 14px;
  border: 2px solid #2aabee;
  padding: 0 12px;
  box-sizing: border-box;
  background: #fff;
}

button {
  width: 100%;
  height: 56px;
  margin-top: 18px;
  font-size: 28px;
  font-weight: 700;
  border: 0;
  border-radius: 14px;
  background: #2aabee;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  cursor: pointer;
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.hint {
  margin-top: 12px;
  font-size: 14px;
  opacity: 0.85;
  text-align: center;
  min-height: 20px;
}

/* Простий спіннер */
.spinner {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 3px solid rgba(255, 255, 255, 0.45);
  border-top-color: #fff;
  animation: spin 0.8s linear infinite;
  display: none;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Коли йде збереження */
.saving .spinner { display: inline-block; }

/* Коли йде перевірка доступу */
.checking .spinner { display: inline-block; }
</style>

</head>

<body>
  <div class="box">
    <div class="label">Показники заправки генератора</div>

    <div class="field-label">Дата заправки</div>
    <input type="date" style="width: 90%;" id="date" />

    <div class="field-label">Час заправки</div>
    <input type="time" style="width:90%;" id="time" step="60" />
     
    <div class="field-label">Скільки літрів заправлено</div>
    <input type="number" id="liters" style="width:4em;" inputmode="numeric" min="0" step="1"  />
   
    <button id="btnSave" onclick="send()">
      <span class="spinner" aria-hidden="true"></span>
      <span id="btnText">Зберегти</span>
    </button>

    <div class="hint" id="status"></div>
  </div>

  <script>
    // ✅ URL Apps Script
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxrC-JQWWUTJgXmIjk-_MUabT6Cub_f9oVKNouUvRx2u6GYSkelUc0Z69MJcwCa4eBr/exec";

    const elDate = document.getElementById("date");
    const elTime = document.getElementById("time");
    const elLiters = document.getElementById("liters");
    
    const btn = document.getElementById("btnSave");
    const btnText = document.getElementById("btnText");
    const statusEl = document.getElementById("status");

    //function setStatus(text) { statusEl.innerHTML  = text || ""; }

    function setStatus(icon, text) {
      if (!icon && !text) {
        statusEl.innerHTML = "";
        return;
      }
    
      statusEl.innerHTML = `
        <div style="
          display:flex;
          flex-direction:column;
          align-items:center;
          justify-content:center;
          text-align:center;
          min-height:48px;
          gap:6px;
        ">
          ${icon ? `
            <div style="
              font-size:22px;
              line-height:1;
            ">${icon}</div>
          ` : ""}
          ${text ? `
            <div style="
              font-size:14px;
              opacity:0.9;
            ">${text}</div>
          ` : ""}
        </div>
      `;
    }
    
    function setUiState(state) {
      // state: "checking" | "blocked" | "idle" | "saving" | "saved" | "error"

      if (state === "checking") {
        elDate.disabled = true;
        elLiters.disabled = true;
        elTime.disabled = true;
        btn.disabled = true;
        btn.classList.add("checking");
        btn.classList.remove("saving");
        btnText.textContent = "Перевірка…";
        setStatus("⏳","Перевіряю доступ…");
        return;
      }

      if (state === "blocked") {
        //elDate.disabled = true;
        //elLiters.disabled = true;
        //elTime.disabled = true;
        btn.disabled = true;
        btn.classList.remove("checking");
        btn.classList.remove("saving");
        btnText.textContent = "Зберегти";
        // status вже виставляється ззовні (помилка)
        return;
      }

      if (state === "saving") {
        elDate.disabled = true;
        elLiters.disabled = true;
        elTime.disabled = true;
        btn.disabled = true;
        btn.classList.remove("checking");
        btn.classList.add("saving");
        btnText.textContent = "Збереження…";
        setStatus("⏳","Йде збереження…");
        return;
      }

      if (state === "saved") {
        elDate.disabled = true;
        elLiters.disabled = true;
        elTime.disabled = true;
        btn.disabled = true;
        btn.classList.remove("checking");
        btn.classList.remove("saving");
        btnText.textContent = "Збережено";
        setStatus("✅","Дякуємо за заправку");
        return;
      }

      if (state === "error") {
        elDate.disabled = false;
        elLiters.disabled = false;
        elTime.disabled = false;
        btn.disabled = false;
        btn.classList.remove("checking");
        btn.classList.remove("saving");
        btnText.textContent = "Зберегти";
        return;
      }

      // idle
      elDate.disabled = false;
      elLiters.disabled = false;
      elTime.disabled = false;
      btn.disabled = false;
      btn.classList.remove("checking");
      btn.classList.remove("saving");
      btnText.textContent = "Зберегти";
      setStatus("","");
    }

    // Поточна дата/час по Києву
    function setNowKyivDefaults() {
      const tz = "Europe/Kyiv";
      const d = new Date();

      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: tz,
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      }).formatToParts(d);

      const map = {};
      for (const p of parts) if (p.type !== "literal") map[p.type] = p.value;

      elDate.value = `${map.year}-${map.month}-${map.day}`;
      elTime.value = `${map.hour}:${map.minute}`;
    }

    function markError(el) {
      if (!el.value) el.classList.add("input-error");
      else el.classList.remove("input-error");
    }

    // ✅ 1) Одразу блокуємо форму
    setUiState("checking");

    // ✅ 2) Запускаємо перевірку доступу (без top-level await)
    (async function checkAccessOnLoad() {
      try {
        const tg = window.Telegram?.WebApp || null;

        const params = new URLSearchParams({
          action: "checkAccess",
          user_id:   tg?.initDataUnsafe?.user?.id       ? String(tg.initDataUnsafe.user.id)       : "",
          user_code: tg?.initDataUnsafe?.user?.username ? String(tg.initDataUnsafe.user.username) : "",
          user_name: tg?.initDataUnsafe?.user?.first_name ? String(tg.initDataUnsafe.user.first_name) : ""
        });

        const url = GAS_URL + "?" + params.toString();

        const res = await fetch(url, { method: "GET", cache: "no-store" });

        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch { json = { ok: false, error: text }; }

        if (!json.ok) {
          setStatus("❌", (json.error || "Нема доступу"));
          setUiState("blocked");
          return;
        }

        // ✅ Доступ є — розблоковуємо форму
        setUiState("idle");

      } catch (e) {
        console.error(e);
        setStatus("❌","Помилка перевірки доступу");
        setUiState("blocked");
      }
    })();

    // Далі — твоя існуюча логіка
    setNowKyivDefaults();

    [elDate, elTime, elLiters].forEach(el => {
      el.addEventListener("input", () => markError(el));
    });
    markError(elDate);
    markError(elTime);
    markError(elLiters);

    async function send() {
      const tg = window.Telegram?.WebApp || null;

      const date = elDate.value;
      const time = elTime.value;
      const liters = elLiters.value;

      if (!date) { alert("Вкажіть дату"); return; }
      if (!time) { alert("Вкажіть час"); return; }

      if (!liters) {
        if (!confirm(`Зберегти дані без вказаного об'єму ⛽ заправки?`)) return;
      } else {
        if (!confirm(`Підтверджуєте заправку \n⛽ ${elLiters.value} літрів?`)) return;
      }

      try {
        setUiState("saving");

        const params = new URLSearchParams({
          action: "save",
          date_zp: `${date} ${time}`,
          liters: String(liters),
          user_id:   tg?.initDataUnsafe?.user?.id         ? String(tg.initDataUnsafe.user.id)         : "",
          user_code: tg?.initDataUnsafe?.user?.username   ? String(tg.initDataUnsafe.user.username)   : "",
          user_name: tg?.initDataUnsafe?.user?.first_name ? String(tg.initDataUnsafe.user.first_name) : "",
          platform:  tg?.platform || "",
          dop_param: tg?.initDataUnsafe?.start_param      ? String(tg.initDataUnsafe.start_param)     : ""
        });

        const url = GAS_URL + "?" + params.toString();

        const res = await fetch(url, { method: "GET" });

        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch { json = { ok:false, error:text }; }

        if (!json.ok) {
          setStatus("❌","Помилка: " + (json.error || "unknown"));
          setUiState("error");
          if (tg) tg.HapticFeedback?.notificationOccurred?.("error");
          return;
        }

        setUiState("saved");
        if (tg) tg.HapticFeedback?.notificationOccurred?.("success");

      } catch (err) {
        setStatus("❌","Помилка: " + err.message);
        setUiState("error");
        if (tg) tg.HapticFeedback?.notificationOccurred?.("error");
      }
    }
  </script>
</body>
</html>
