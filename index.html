<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <title>–ó–∞–ø—Ä–∞–≤–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
body {
  margin: 0;
  padding: 16px;
  font-family: -apple-system, Segoe UI, Roboto, Arial;
}

.box {
  max-width: 420px;
  margin: 0 auto;
}

.label {
  text-align: center;
  font-size: 24px;
  font-weight: 600;
  margin: 10px 0 18px;
}

.field-label {
  font-size: 18px;
  font-weight: 600;
  margin-top: 14px;
  margin-bottom: 6px;
}
    
.input-error {
  border-color: #e53935 !important;   /* —á–µ—Ä–≤–æ–Ω–∞ —Ä–∞–º–∫–∞ */
  box-shadow: 0 0 0 2px rgba(229,57,53,0.15);
}
    
input[type="number"],
input[type="date"],
input[type="time"] {
  height: 56px;
  font-size: 28px;
  border-radius: 14px;
  border: 2px solid #2aabee;
  padding: 0 12px;
  box-sizing: border-box;
  background: #fff;
}

button {
  width: 100%;
  height: 56px;
  margin-top: 18px;
  font-size: 28px;
  font-weight: 700;
  border: 0;
  border-radius: 14px;
  background: #2aabee;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  cursor: pointer;
}

button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.hint {
  margin-top: 12px;
  font-size: 14px;
  opacity: 0.85;
  text-align: center;
  min-height: 20px;
}

/* –ü—Ä–æ—Å—Ç–∏–π —Å–ø—ñ–Ω–Ω–µ—Ä */
.spinner {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 3px solid rgba(255, 255, 255, 0.45);
  border-top-color: #fff;
  animation: spin 0.8s linear infinite;
  display: none;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* –ö–æ–ª–∏ –π–¥–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è */
.saving .spinner {
  display: inline-block;
}
</style>

</head>

<body>
  <div class="box">
    <div class="label">–ü–æ–∫–∞–∑–Ω–∏–∫–∏ –∑–∞–ø—Ä–∞–≤–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞</div>

    <div class="field-label">–î–∞—Ç–∞ –∑–∞–ø—Ä–∞–≤–∫–∏</div>
    <input type="date" style="width: 90%;" id="date" />

    <div class="field-label">–ß–∞—Å –∑–∞–ø—Ä–∞–≤–∫–∏</div>
    <input type="time" style="width:90%;" id="time" step="60" />
     
    <div class="field-label">–°–∫—ñ–ª—å–∫–∏ –ª—ñ—Ç—Ä—ñ–≤ –∑–∞–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
    <input type="number" id="liters" style="width:4em;" inputmode="numeric" min="0" step="1"  />
   
    <button id="btnSave" onclick="send()">
      <span class="spinner" aria-hidden="true"></span>
      <span id="btnText">–ó–±–µ—Ä–µ–≥—Ç–∏</span>
    </button>

    <div class="hint" id="status"></div>
  </div>

  <script>
    // ‚úÖ –í–°–¢–ê–í –°–Æ–î–ò –°–í–Ü–ô URL Apps Script (–±–µ–∑ –∑–∞–π–≤–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ —Ç–∏–ø—É ?–≤—ã=2)
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxrC-JQWWUTJgXmIjk-_MUabT6Cub_f9oVKNouUvRx2u6GYSkelUc0Z69MJcwCa4eBr/exec";

    const elDate = document.getElementById("date");
    const elTime = document.getElementById("time");
    const elLiters = document.getElementById("liters");
    
    const btn = document.getElementById("btnSave");
    const btnText = document.getElementById("btnText");
    const statusEl = document.getElementById("status");


    
    function setStatus(text) { statusEl.textContent = text || ""; }


    
    function setUiState(state) {
      // state: "idle" | "saving" | "saved" | "error"
      if (state === "saving") {
        elDate.disabled = true;
        elLiters.disabled = true;
        elTime.disabled = true;
        btn.disabled = true;              // —â–æ–± –Ω–µ –Ω–∞—Ç–∏—Å–∫–∞–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ
        btn.classList.add("saving");
        btnText.textContent = "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶";
        setStatus("–ô–¥–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶");
        return;
      }

      if (state === "saved") {
        elDate.disabled = true;
        elLiters.disabled = true;
        elTime.disabled = true;
        btn.disabled = true;              // –ø—ñ—Å–ª—è —É—Å–ø—ñ—Ö—É –ª–∏—à–∞—î–º–æ disabled
        btn.classList.remove("saving");
        btnText.textContent = "–ó–±–µ—Ä–µ–∂–µ–Ω–æ";
        setStatus("‚úÖ –î—è–∫—É—î–º–æ –∑–∞ –∑–∞–ø—Ä–∞–≤–∫—É");
        return;
      }

      if (state === "error") {
        elDate.disabled = false;
        elLiters.disabled = false;
        elTime.disabled = false;
        btn.disabled = false;             // –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ –¥–∞—î–º–æ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑
        btn.classList.remove("saving");
        btnText.textContent = "–ó–±–µ—Ä–µ–≥—Ç–∏";
        return;
      }

      // idle
      elDate.disabled = false;
      elLiters.disabled = false;
      elTime.disabled = false;
      btn.disabled = false;
      btn.classList.remove("saving");
      btnText.textContent = "–ó–±–µ—Ä–µ–≥—Ç–∏";
      setStatus("");
    }

    // –ü–æ—Ç–æ—á–Ω–∞ –¥–∞—Ç–∞/—á–∞—Å –ø–æ –ö–∏—î–≤—É
    function setNowKyivDefaults() {
      const tz = "Europe/Kyiv";
      const d = new Date();

      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: tz,
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      }).formatToParts(d);

      const map = {};
      for (const p of parts) if (p.type !== "literal") map[p.type] = p.value;

      elDate.value = `${map.year}-${map.month}-${map.day}`;
      elTime.value = `${map.hour}:${map.minute}`;
    }

    setNowKyivDefaults();

    [elDate, elTime, elLiters].forEach(el => {
      el.addEventListener("input", () => {
        markError(el);
      });
    });
    markError(elDate);
    markError(elTime);
    markError(elLiters);
    
    function markError(el) {
      if (!el.value) {
        el.classList.add("input-error");
      } else {
        el.classList.remove("input-error");
      }
    }
    
    async function send() {
      const tg = window.Telegram?.WebApp || null;

      const date = elDate.value;
      const time = elTime.value;
      const liters = elLiters.value;

      if (!date) { alert("–í–∫–∞–∂—ñ—Ç—å –¥–∞—Ç—É"); return; }
      if (!time) { alert("–í–∫–∞–∂—ñ—Ç—å —á–∞—Å"); return; }


      if (!confirm(`–ó–±–µ—Ä–µ–≥—Ç–∏?\n\nüìÖ ${elDate.value}\n‚è∞ ${elTime.value}\n‚õΩ ${elLiters.value} –ª`))
      {
        return;
      }
        
      if (!liters) { alert("–í–∫–∞–∂—ñ—Ç—å –æ–± º—î–º (–ª—ñ—Ç—Ä–∏)"); return; }

      console.log("SetTimeGenerator!");
      
      try {
        setUiState("saving");

        const params = new URLSearchParams({
          action: "save",
          date_zp: `${date} ${time}`,
          liters: String(liters),
          user_id:   tg?.initDataUnsafe?.user?.id         ? String(tg.initDataUnsafe.user.id)         : "",
          user_code: tg?.initDataUnsafe?.user?.username   ? String(tg.initDataUnsafe.user.username)   : "", 
          user_name: tg?.initDataUnsafe?.user?.first_name ? String(tg.initDataUnsafe.user.first_name) : "", 
          platform:  tg?.platform || "",
          dop_param: tg?.initDataUnsafe?.start_param      ? String(tg.initDataUnsafe.start_param)     : ""
        });

        const url = GAS_URL + "?" + params.toString();

        const res = await fetch(url, { method: "GET" });

        // —è–∫—â–æ GAS –ø–æ–≤–µ—Ä–Ω—É–≤ –Ω–µ JSON (—ñ–Ω–∫–æ–ª–∏ –±—É–≤–∞—î –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ –¥–µ–ø–ª–æ—é)
        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch { json = { ok:false, error:text }; }

        if (!json.ok) {
          setStatus("‚ùå –ü–æ–º–∏–ª–∫–∞: " + (json.error || "unknown"));
          setUiState("error");
          if (tg) tg.HapticFeedback?.notificationOccurred?.("error");
          return;
        }

        setUiState("saved");
        if (tg) tg.HapticFeedback?.notificationOccurred?.("success");

      } catch (err) {
        setStatus("‚ùå –ü–æ–º–∏–ª–∫–∞: " + err.message);
        setUiState("error");
        const tg = window.Telegram?.WebApp || null;
        if (tg) tg.HapticFeedback?.notificationOccurred?.("error");
      }
    }
  </script>
</body>
</html>
