<!doctype html>
<html lang="uk">

<head>
    <meta charset="utf-8" />
    <title>–ó–∞–ø—Ä–∞–≤–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 16px;
            font-family: -apple-system, Segoe UI, Roboto, Arial;
        }

        .test-badge {
            margin: 0 auto 12px;
            padding: 6px 12px;
            border-radius: 12px;
            background: #e53935;
            color: #fff;
            font-weight: 700;
            font-size: 14px;
            text-align: center;
            width: fit-content;
            display: none;
            /* –ø—Ä–∏—Ö–æ–≤–∞–Ω–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
        }

        .box {
            max-width: 420px;
            margin: 0 auto;
        }

        .label {
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            margin: 10px 0 18px;
        }

        .field-label {
            font-size: 18px;
            font-weight: 600;
            margin-top: 14px;
            margin-bottom: 6px;
        }

        .__input-error {
            border-color: #e53935 !important;
            /* —á–µ—Ä–≤–æ–Ω–∞ —Ä–∞–º–∫–∞ */
            box-shadow: 0 0 0 2px rgba(229, 57, 53, 0.15);
        }

        input[type="number"],
        input[type="date"],
        input[type="time"] {
            height: 56px;
            font-size: 28px;
            border-radius: 14px;
            border: 2px solid #2aabee;
            padding: 0 12px;
            box-sizing: border-box;
            background: #fff;
        }

        button {
            width: 100%;
            height: 56px;
            margin-top: 18px;
            font-size: 28px;
            font-weight: 700;
            border: 0;
            border-radius: 14px;
            background: #2aabee;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .hint {
            margin-top: 12px;
            font-size: 14px;
            opacity: 0.85;
            text-align: center;
            min-height: 20px;
        }

        /* –ü—Ä–æ—Å—Ç–∏–π —Å–ø—ñ–Ω–Ω–µ—Ä */
        .spinner {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.45);
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* –ö–æ–ª–∏ –π–¥–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è */
        .saving .spinner {
            display: inline-block;
        }

        /* –ö–æ–ª–∏ –π–¥–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É */
        .checking .spinner {
            display: inline-block;
        }
    </style>

</head>

<body>
    <div id="testBadge" class="test-badge">–¢–µ—Å—Ç–æ–≤–∏–π —Ä–µ–∂–∏–º</div>
    <div class="box">
        <div id="labelMain" class="label">–ü–æ–∫–∞–∑–Ω–∏–∫–∏ –∞–∫—Ç—É–∞–ª—ñ–∑–∞—Ü—ñ—ó –º–æ—Ç–æ–≥–æ–¥–∏–Ω</div>

        <div id="labelDate" class="field-label">–î–∞—Ç–∞</div>
        <input type="date" style="width: 90%;" id="date" />

        <div id="labelTime" class="field-label">–í–∫–∞–∂—ñ—Ç—å —á–∞—Å</div>
        <input type="time" style="width:90%;" id="time" step="60" />

        <div class="field-label">–°–∫—ñ–ª—å–∫–∏ –º–æ—Ç–æ–≥–æ–¥–∏–Ω –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ñ –Ω–∞ –≤–∫–∞–∑–∞–Ω–∏–π —á–∞—Å</div>
        <input type="number" id="moto" style="width:4em;" inputmode="numeric" min="0" max="200" step="1" />

        <button id="btnSave" onclick="send()">
            <span class="spinner" aria-hidden="true"></span>
            <span id="btnText">–ó–±–µ—Ä–µ–≥—Ç–∏</span>
        </button>

        <div class="hint" id="status"></div>
    </div>

    <script>
        // ‚úÖ URL Apps Script
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxrC-JQWWUTJgXmIjk-_MUabT6Cub_f9oVKNouUvRx2u6GYSkelUc0Z69MJcwCa4eBr/exec";

        const elDate = document.getElementById("date");
        const elTime = document.getElementById("time");
        const elMoto = document.getElementById("moto");

        const btn = document.getElementById("btnSave");
        const btnText = document.getElementById("btnText");
        const statusEl = document.getElementById("status");


        const testBadge = document.getElementById("testBadge");





        const tg = window.Telegram?.WebApp || null;
        const startParam = tg?.initDataUnsafe?.start_param
            ? String(tg.initDataUnsafe.start_param)
            : "";

        if (startParam.includes("IsTO=Yes")) {
            document.getElementById("labelMain").textContent = "–ü–æ–∫–∞–∑–Ω–∏–∫–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –¢–û";
            document.getElementById("labelDate").textContent = "–î–∞—Ç–∞ –¢–û";
            document.getElementById("labelTime").textContent = "–í–∫–∞–∂—ñ—Ç—å —á–∞—Å, –∫–æ–ª–∏ –±—É–ª–æ –∑–∞–∫—ñ–Ω—á–µ–Ω–æ –¢–û";

        }




        if (startParam.includes("IsTest=Yes")) {
            testBadge.style.display = "block";
        }

        //function setStatus(text) { statusEl.innerHTML  = text || ""; }

        elMoto.addEventListener("input", () => {
            let v = elMoto.value.replace(/\D/g, ""); // —Ç—ñ–ª—å–∫–∏ —Ü–∏—Ñ—Ä–∏
            if (v.length > 3) v = v.slice(0, 3);
            elMoto.value = v;
        });

        function setStatus(icon, text) {
            if (!icon && !text) {
                statusEl.innerHTML = "";
                return;
            }


            statusEl.innerHTML = `
        <div style="
          display:flex;
          align-items:center;        /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–µ –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è —ñ–∫–æ–Ω–∫–∏ + —Ç–µ–∫—Å—Ç—É */
          justify-content:center;    /* —Ü–µ–Ω—Ç—Ä –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—ñ */
          min-height:48px;
          gap:10px;
          text-align:left;
        ">
          ${icon ? `
            <div style="
              font-size:22px;
              line-height:1;
              flex-shrink:0;
            ">${icon}</div>
          ` : ""}
          ${text ? `
            <div style="
              font-size:14px;
              opacity:0.9;
              line-height:1.25;
            ">${text}</div>
          ` : ""}
        </div>
      `;
        }


        function setUiState(state) {
            // state: "checking" | "blocked" | "idle" | "saving" | "saved" | "error"
            const tg = window.Telegram?.WebApp || null;
            var userName = tg?.initDataUnsafe?.user?.first_name ? String(tg.initDataUnsafe.user.first_name) : "";

            if (state === "checking") {
                elDate.disabled = false;
                elMoto.disabled = false;
                elTime.disabled = false;
                btn.disabled = true;
                btn.classList.add("checking");
                btn.classList.remove("saving");
                btnText.textContent = "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞‚Ä¶";
                setStatus("‚è≥", "–ü–µ—Ä–µ–≤—ñ—Ä—è—é –¥–æ—Å—Ç—É–ø‚Ä¶");
                return;
            }

            if (state === "blocked") {
                elDate.disabled = false;
                elMoto.disabled = false;
                elTime.disabled = false;
                btn.disabled = true;
                btn.classList.remove("checking");
                btn.classList.remove("saving");
                btnText.textContent = "–ó–±–µ—Ä–µ–≥—Ç–∏";
                // status –≤–∂–µ –≤–∏—Å—Ç–∞–≤–ª—è—î—Ç—å—Å—è –∑–∑–æ–≤–Ω—ñ (–ø–æ–º–∏–ª–∫–∞)
                return;
            }

            if (state === "saving") {
                elDate.disabled = true;
                elMoto.disabled = true;
                elTime.disabled = true;
                btn.disabled = true;
                btn.classList.remove("checking");
                btn.classList.add("saving");
                btnText.textContent = "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶";
                setStatus("‚è≥", "–ô–¥–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶");
                return;
            }

            if (state === "saved") {
                elDate.disabled = true;
                elMoto.disabled = true;
                elTime.disabled = true;
                btn.disabled = true;
                btn.classList.remove("checking");
                btn.classList.remove("saving");
                btnText.textContent = "‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ";
                setStatus("ü§ù", userName + ", –¥—è–∫—É—î–º–æ –∑–∞ –∑–∞–ø—Ä–∞–≤–∫—É!"); //
                return;
            }

            if (state === "error") {
                elDate.disabled = false;
                elMoto.disabled = false;
                elTime.disabled = false;
                btn.disabled = false;
                btn.classList.remove("checking");
                btn.classList.remove("saving");
                btnText.textContent = "–ó–±–µ—Ä–µ–≥—Ç–∏";
                return;
            }

            // idle
            elDate.disabled = false;
            elMoto.disabled = false;
            elTime.disabled = false;
            btn.disabled = false;
            btn.classList.remove("checking");
            btn.classList.remove("saving");
            btnText.textContent = "–ó–±–µ—Ä–µ–≥—Ç–∏";
            setStatus("üîë", userName + ", —É –≤–∞—Å —î –¥–æ—Å—Ç—É–ø –¥–æ –≤–Ω–µ—Å–µ–Ω–Ω—è –ø–æ–∫–∞–∑–Ω–∏–∫—ñ–≤");
        }

        // –ü–æ—Ç–æ—á–Ω–∞ –¥–∞—Ç–∞/—á–∞—Å –ø–æ –ö–∏—î–≤—É
        function setNowKyivDefaults() {
            const tz = "Europe/Kyiv";
            const d = new Date();
            d.setMinutes(d.getMinutes() - 5);

            const parts = new Intl.DateTimeFormat("en-CA", {
                timeZone: tz,
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                hour12: false
            }).formatToParts(d);

            const map = {};
            for (const p of parts) if (p.type !== "literal") map[p.type] = p.value;

            elDate.value = `${map.year}-${map.month}-${map.day}`;
            elTime.value = `${map.hour}:${map.minute}`;
        }

        // ‚úÖ "–ó–∞—Ä–∞–∑" —É –ö–∏—î–≤—ñ —è–∫ Date (–¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫)
        function getNowKyiv() {
            const tz = "Europe/Kyiv";
            const d = new Date();

            const parts = new Intl.DateTimeFormat("en-CA", {
                timeZone: tz,
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: false
            }).formatToParts(d);

            const m = {};
            for (const p of parts) if (p.type !== "literal") m[p.type] = p.value;

            // –°–æ–∑–¥–∞—ë–º Date –∏–∑ "–∫–∏–µ–≤—Å–∫–∏—Ö" –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
            return new Date(
                Number(m.year),
                Number(m.month) - 1,
                Number(m.day),
                Number(m.hour),
                Number(m.minute),
                Number(m.second)
            );
        }

        // ‚úÖ –ü–∞—Ä—Å–∏–º –≤–≤–µ–¥—ë–Ω–Ω—ã–µ date+time –≤ Date
        function parseInputDateTime(dateStr, timeStr) {
            const [y, mo, d] = (dateStr || "").split("-").map(Number);
            const [hh, mm] = (timeStr || "").split(":").map(Number);

            if (!y || !mo || !d || Number.isNaN(hh) || Number.isNaN(mm)) return null;

            return new Date(y, mo - 1, d, hh, mm, 0);
        }

        function markError(el) {
            if (!el.value) el.classList.add("input-error");
            else el.classList.remove("input-error");
        }

        // ‚úÖ 1) –û–¥—Ä–∞–∑—É –±–ª–æ–∫—É—î–º–æ —Ñ–æ—Ä–º—É
        setUiState("checking");

        // ‚úÖ 2) –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –¥–æ—Å—Ç—É–ø—É (–±–µ–∑ top-level await)
        (async function checkAccessOnLoad() {
            try {
                const tg = window.Telegram?.WebApp || null;

                const u = tg?.initDataUnsafe?.user;
                const userName = u
                    ? [u.first_name, u.last_name].filter(Boolean).join(" ")
                    : "";

                const startParam = tg?.initDataUnsafe?.start_param
                    ? String(tg.initDataUnsafe.start_param)
                    : "";
                    
                const params = new URLSearchParams({
                    action: "checkAccess",
                    user_id: tg?.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : "",
                    user_code: tg?.initDataUnsafe?.user?.username ? String(tg.initDataUnsafe.user.username) : "",
                    user_name: userName,
                    platform: tg?.platform || "",
                    dop_param: startParam,
                    source: istartParam.includes("IsTO=Yes") ? "–î–æ—Å—Ç—É–ø_–¥–æ_–¢–û" : "–î–æ—Å—Ç—É–ø_–¥–æ_–∞–∫—Ç—É–∞–ª—ñ–∑–∞—Ü—ñ—ó"

                });

                const url = GAS_URL + "?" + params.toString();

                const res = await fetch(url, { method: "GET", cache: "no-store" });

                const text = await res.text();
                let json;
                try { json = JSON.parse(text); } catch { json = { ok: false, error: text }; }

                if (!json.ok) {
                    setStatus("‚ùå", (json.error || "–ù–µ–º–∞ –¥–æ—Å—Ç—É–ø—É"));
                    setUiState("blocked");
                    return;
                }

                // ‚úÖ –î–æ—Å—Ç—É–ø —î ‚Äî —Ä–æ–∑–±–ª–æ–∫–æ–≤—É—î–º–æ —Ñ–æ—Ä–º—É
                setUiState("idle");

            } catch (e) {
                console.error(e);
                setStatus("‚ùå", "–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø—É");
                setUiState("blocked");
            }
        })();

        // –î–∞–ª—ñ ‚Äî —Ç–≤–æ—è —ñ—Å–Ω—É—é—á–∞ –ª–æ–≥—ñ–∫–∞
        setNowKyivDefaults();

        [elDate, elTime, elMoto].forEach(el => {
            el.addEventListener("input", () => markError(el));
        });
        markError(elDate);
        markError(elTime);
        markError(elMoto);

        async function send() {
            const tg = window.Telegram?.WebApp || null;



        const startParam = tg?.initDataUnsafe?.start_param
            ? String(tg.initDataUnsafe.start_param)
            : "";



            const date = elDate.value;
            const time = elTime.value;
            const moto = elMoto.value;

            if (!date) { alert("–í–∫–∞–∂—ñ—Ç—å –¥–∞—Ç—É"); return; }
            if (!time) { alert("–í–∫–∞–∂—ñ—Ç—å —á–∞—Å"); return; }
            if (!moto) { alert("–í–∫–∞–∂—ñ—Ç—å —Å–∫—ñ–ª—å–∫–∏ –º–æ—Ç–æ–≥–æ–¥–∏–Ω –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ñ"); return; }

            // ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏ —á–∞—Å—É (–∑–∞ –ö–∏—î–≤–æ–º)
            const nowKyiv = getNowKyiv();
            const inputDt = parseInputDateTime(date, time);

            if (!inputDt) {
                alert("–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–æ –≤–∫–∞–∑–∞–Ω—ñ –¥–∞—Ç–∞ –∞–±–æ —á–∞—Å");
                return;
            }

            // 1) –ù–µ –º–æ–∂–µ –±—É—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ –ø–æ—Ç–æ—á–Ω–æ–≥–æ —á–∞—Å—É (–ö–∏—ó–≤)
            if (inputDt.getTime() > nowKyiv.getTime()) {
                alert("‚ùó –í–∫–∞–∑–∞–Ω–∏–π —á–∞—Å –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –±—ñ–ª—å—à–∏–º –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–π ");
                return;
            }
            console.log("send");


          if (startParam.includes("IsTO=Yes")) 
          {
            if (!confirm(`–í–∏ –≤–∫–∞–∑–∞–ª–∏:\n1) üïí —á–∞—Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –¢–û - ${time}\n2) ‚è≥ ${elMoto.value} –º–æ—Ç–æ–≥–æ–¥–∏–Ω –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ñ\n\n–í—Å—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –≤—ñ—Ä–Ω—ñ? `)) return;

        }
        else
        {
            if (!confirm(`–í–∏ –≤–∫–∞–∑–∞–ª–∏:\n1) üïí —á–∞—Å - ${time}\n2) ‚è≥ ${elMoto.value} –º–æ—Ç–æ–≥–æ–¥–∏–Ω –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ñ\n\n–í—Å—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ –≤—ñ—Ä–Ω—ñ? `)) return;
        }

          





            try {
                setUiState("saving");
                const u = tg?.initDataUnsafe?.user;
                const userName = u
                    ? [u.first_name, u.last_name].filter(Boolean).join(" ")
                    : "";

                const params = new URLSearchParams({
                    action: "saveTO",
                    date_zp: `${date} ${time}`,
                    moto: String(moto),
                    user_id: tg?.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : "",
                    user_code: tg?.initDataUnsafe?.user?.username ? String(tg.initDataUnsafe.user.username) : "",
                    user_name: userName,
                    platform: tg?.platform || "",
                    dop_param: startParam
                });

                const url = GAS_URL + "?" + params.toString();

                const res = await fetch(url, { method: "GET" });

                const text = await res.text();
                let json;
                try { json = JSON.parse(text); } catch { json = { ok: false, error: text }; }

                if (!json.ok) {
                    setStatus("‚ùå", "–ü–æ–º–∏–ª–∫–∞: " + (json.error || "unknown"));
                    setUiState("error");
                    if (tg) tg.HapticFeedback?.notificationOccurred?.("error");
                    return;
                }

                setUiState("saved");
                if (tg) tg.HapticFeedback?.notificationOccurred?.("success");

            } catch (err) {
                setStatus("‚ùå", "–ü–æ–º–∏–ª–∫–∞: " + err.message);
                setUiState("error");
                if (tg) tg.HapticFeedback?.notificationOccurred?.("error");
            }
        }
    </script>
</body>

</html>